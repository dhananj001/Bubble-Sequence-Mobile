<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> -->
  <meta name="theme-color" content="#fcb69f" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


  <link rel="manifest" href="/manifest.json">
  <title>🫧 Bubble&nbsp;Rush</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #fff9d1 0%, #e0f3ff 40%, #ffd6de 80%, #d9ffd6 100%);
      min-height: 100vh;
      min-height: 100dvh;
      height: 100%;
      overflow: hidden;
      position: relative;
      box-sizing: border-box;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    body {
      margin: 0;
      font-family: 'Baloo 2', 'Comic Sans MS', cursive, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: none;
      overflow: hidden;
      touch-action: none;
      /* Prevent zoom/pan on mobile */
      position: relative;
      transition: background 0.8s cubic-bezier(.4,0,.2,1); /* Smooth background transition */
    }

    body::before, body::after {
      content: '';
      position: fixed;
      z-index: 0;
      border-radius: 50%;
      opacity: 0.18;
      pointer-events: none;
      filter: blur(2px);
    }
    body::before {
      width: 38vw;
      height: 38vw;
      left: -10vw;
      top: 8vh;
      background: radial-gradient(circle, #ffe7a0 60%, #fff9d1 100%);
    }
    body::after {
      width: 48vw;
      height: 48vw;
      right: -18vw;
      bottom: 0vh;
      background: radial-gradient(circle, #b6eaff 60%, #e0f3ff 100%);
    }

    h1 {
      margin: 10px;
      font-size: 6vw;
      /* Responsive text */
      text-align: center;
    }

    #status {
      display: flex;
      gap: 10vw;
      margin-bottom: 8px;
      font-size: 4vw;
    }

    #progressBar {
      width: 90vw;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    #progress {
      height: 100%;
      background: #76c7c0;
      width: 100%;
      transition: width 1s linear;
    }

    #canvas-container {
      position: relative;
      width: 95vw;
      height: 55vh;
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
      border: none;
      background: none;
    }

    .arrow {
      position: absolute;
      pointer-events: none;
      transform: scale(1.2);
    }

    #modal,
    #startModal,
    #settingsModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(2px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .modalContent {
      background: #fff;
      padding: 20px;
      width: 80vw;
      max-width: 400px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .modalContent h2 {
      font-size: 5vw;
    }

    .modalContent p {
      font-size: 4vw;
      margin-bottom: 15px;
    }

    button {
      width: 90%;
      padding: 14px;
      margin: 10px auto;
      font-size: 4.5vw;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: block;
    }

    button:hover {
      background: #555;
    }

    #settingsIcon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 8vw;
      cursor: pointer;
    }

    #game-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: none;
    }

    #startModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #fff9d1 0%, #e0f3ff 40%, #ffd6de 80%, #d9ffd6 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      /* padding: 4vh 0; */
      z-index: 100;
      transition: opacity 0.4s;
    }
    .modalContent {
      background: rgba(255,255,255,0.85);
      padding: 28px 18px 20px 18px;
      max-width: 90vw;
      max-height: 80vh;
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      margin: auto;
    }
    .modalContent h2 {
      font-size: 2.2em;
      margin-bottom: 0.2em;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #fff9d1cc, 0 1px 0 #fff;
    }
    .star-rating {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 12px 0 8px 0;
    }
    .star {
      width: 32px;
      height: 32px;
      display: inline-block;
      opacity: 0.85;
    }
    .star-animate {
      animation: star-popspin 0.7s cubic-bezier(.68,-0.55,.27,1.55) forwards;
    }
    @keyframes star-popspin {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      60% { transform: scale(1.2) rotate(360deg); opacity: 1; }
      80% { transform: scale(0.95) rotate(450deg); }
      100% { transform: scale(1) rotate(540deg); opacity: 1; }
    }
    .modalContent .highscore {
      font-size: 1.2em;
      margin-bottom: 1.2em;
      color: #333;
      background: #fff9d1;
      border-radius: 8px;
      padding: 4px 16px;
      box-shadow: 0 1px 4px #ffd70033;
    }
    .modalContent .difficulty {
      display: flex;
      gap: 12px;
      margin: 1.2em 0 1.6em 0;
    }
    .modalContent .difficulty button {
      font-family: 'Baloo 2', 'Comic Sans MS', cursive, sans-serif;
      font-size: 1.1em;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      background: #e0f3ff;
      color: #222;
      box-shadow: 0 1px 4px #1e90ff22;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modalContent .difficulty button.selected,
    .modalContent .difficulty button:active {
      background: #ffd700;
      color: #222;
    }
    .modalContent .playBtn {
      font-size: 1.5em;
      padding: 18px 0;
      border-radius: 32px;
      border: none;
      width: 80%;
      background: linear-gradient(90deg, #FFD700 0%, #FFD6DE 100%);
      color: #222;
      font-weight: bold;
      margin-top: 1.5em;
      box-shadow: 0 4px 18px 0 #ffd70033, 0 1.5px 0 #fff9d1cc;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, transform 0.15s cubic-bezier(.4,0,.2,1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      letter-spacing: 0.5px;
    }
    .modalContent .playBtn:hover, .modalContent .playBtn:active {
      background: linear-gradient(90deg, #FFD6DE 0%, #FFD700 100%);
      color: #fff;
      transform: scale(1.06);
      box-shadow: 0 6px 24px 0 #ffd70055, 0 2px 0 #fff9d1cc;
    }
    .modalContent .settingsBtn {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 2em;
      background: none;
      border: none;
      cursor: pointer;
      color: #888;
      transition: color 0.2s;
    }
    .modalContent .settingsBtn:hover {
      color: #222;
    }
    #startSettingsBtn {
      position: fixed;
      top: 24px;
      right: 24px;
      font-size: 2.2em;
      background: rgba(255,255,255,0.85);
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px #ffd70033;
      cursor: pointer;
      color: #888;
      z-index: 110;
      transition: color 0.2s, background 0.2s;
    }
    #settingsModal {
      z-index: 9999;
    }
    #settingsModal button svg {
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes x-bounce {
      0%   { transform: scale(1) translateY(0);}
      20%  { transform: scale(1.3, 0.7) translateY(-10px);}
      40%  { transform: scale(0.7, 1.3) translateY(10px);}
      60%  { transform: scale(1.2, 0.8) translateY(-6px);}
      80%  { transform: scale(0.9, 1.1) translateY(4px);}
      100% { transform: scale(1) translateY(0);}
    }
    @keyframes x-professional-shake {
      0% { transform: translateX(0); }
      15% { transform: translateX(-8px); }
      30% { transform: translateX(8px); }
      45% { transform: translateX(-6px); }
      60% { transform: translateX(6px); }
      75% { transform: translateX(-4px); }
      90% { transform: translateX(4px); }
      100% { transform: translateX(0); }
    }
    .x-animate {
      display: inline-block;
      animation: x-professional-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      color: #DC143C;
      text-shadow: 0 2px 8px #ffd6decc, 0 1px 0 #fff;
    }
    #homeBtn {
      position: fixed;
      top: 24px;
      left: 24px;
      z-index: 110;
      background: rgba(255,255,255,0.85);
      border-radius: 50%;
      box-shadow: 0 2px 8px #ffd70033;
      cursor: pointer;
      transition: color 0.2s, background 0.2s;
      padding: 6px;
      display: none;
    }
    #homeBtn:hover svg {
      fill: #222;
      stroke: #222;
    }
    .slide-to-play {
      width: 80%;
      margin: 1.5em auto 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }
    .slide-to-play .slide-text {
      font-size: 1.2em;
      color: #888;
      margin-bottom: 0.7em;
      letter-spacing: 1px;
      font-weight: 500;
    }
    .slide-to-play .slide-track {
      width: 100%;
      height: 54px;
      background: linear-gradient(90deg, #202020 0%, #ffd700 100%);
      border-radius: 32px;
      position: relative;
      box-shadow: 0 4px 18px 0 #ffd70033, 0 1.5px 0 #fff9d1cc;
      display: flex;
      align-items: center;
      /* Debug border: remove after testing */
      /* border: 2px dashed #1E90FF; */
    }
    .slide-to-play .slide-thumb {
      width: 54px;
      height: 54px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 2px 8px #ffd70044;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 0;
      top: 0;
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s;
      z-index: 2;
      touch-action: none;
      user-select: none;
      pointer-events: all;
      /* Debug border: remove after testing */
      /* border: 2px solid #DC143C; */
      -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
      outline: none; /* Removes focus outline */
    }
    .slide-to-play .slide-thumb:focus {
      outline: none;
    }
    .slide-to-play .slide-thumb.active {
      box-shadow: 0 4px 16px #ffd70088;
      background: #fff3a7;
    }
    .slide-to-play .slide-thumb.success {
      background: #e0bf00;
      box-shadow: 0 4px 24px #FFD70099;
    }
    .slide-to-play .slide-track {
      overflow: hidden;
      position: relative;
    }
    /* Slide text entrance and exit */
    .slide-to-play .slide-text {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      color: #888;
      letter-spacing: 1px;
      font-weight: 500;
      pointer-events: none;
      user-select: none;
      z-index: 1;
      opacity: 1;
      /* shimmer effect base */
      background: linear-gradient(110deg, transparent 10%, #fff 40%, #fff 70%, transparent 80%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      animation: slide-text-shimmer 1.5s linear infinite;
      filter: blur(var(--slide-blur, 0px));
      transition: filter 0.55s;
    }
    @keyframes slide-text-shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: 0% 0;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
  <h1>🫧 Bubble&nbsp;Rush</h1>

  <div id="status">
    <div>Score: <span id="score">0</span></div>
    <div>High: <span id="highScore">0</span></div>
  </div>

  <div id="progressBar">
    <div id="progress"></div>
  </div>

  <div id="canvas-container">
    <canvas id="canvas"></canvas>

    <!-- Arrows -->
    <svg class="arrow" id="arrow0" width="50" height="20">
      <defs>
        <linearGradient id="arrowGrad0" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#FFF9D1"/>
          <stop offset="100%" stop-color="#FFD700"/>
        </linearGradient>
      </defs>
      <polygon points="0,10 20,0 20,6 50,6 50,14 20,14 20,20" fill="url(#arrowGrad0)" />
    </svg>
    <svg class="arrow" id="arrow1" width="50" height="20">
      <defs>
        <linearGradient id="arrowGrad1" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#E0F3FF"/>
          <stop offset="100%" stop-color="#1E90FF"/>
        </linearGradient>
      </defs>
      <polygon points="0,10 20,0 20,6 50,6 50,14 20,14 20,20" fill="url(#arrowGrad1)" />
    </svg>
    <svg class="arrow" id="arrow2" width="50" height="20">
      <defs>
        <linearGradient id="arrowGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#FFD6DE"/>
          <stop offset="100%" stop-color="#DC143C"/>
        </linearGradient>
      </defs>
      <polygon points="0,10 20,0 20,6 50,6 50,14 20,14 20,20" fill="url(#arrowGrad2)" />
    </svg>
    <svg class="arrow" id="arrow3" width="50" height="20">
      <defs>
        <linearGradient id="arrowGrad3" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#D9FFD6"/>
          <stop offset="100%" stop-color="#32CD32"/>
        </linearGradient>
      </defs>
      <polygon points="0,10 20,0 20,6 50,6 50,14 20,14 20,20" fill="url(#arrowGrad3)" />
    </svg>
  </div>

  <button id="installBtn" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  font-size: 18px;
  padding: 12px 20px;
  border-radius: 8px;
  border: none;
  z-index: 999;
">📲 Install App</button>


  <!-- Modals -->
  <div id="startModal">
    <div class="modalContent">
      <h2>🫧 Bubble&nbsp;Rush</h2>
      <div class="highscore"><span style="font-size:1.2em;vertical-align:middle;">🏆</span> High Score: <span id="startHighScore">0</span></div>
      <div style="font-size:1.1em; color:#444; margin-bottom:1.2em;">Tap bubbles in ascending order. Be quick for bonuses!</div>
      <div class="difficulty">
        <button onclick="selectDifficulty(this, 'easy')"><span style="font-size:1.2em;vertical-align:middle;">🐣</span> Easy</button>
        <button onclick="selectDifficulty(this, 'moderate')"><span style="font-size:1.2em;vertical-align:middle;">🏃</span> Moderate</button>
        <button onclick="selectDifficulty(this, 'hard')"><span style="font-size:1.2em;vertical-align:middle;">🏆</span> Hard</button>
      </div>
      <!-- Slide to Play Slider -->
      <div id="slideToPlay" class="slide-to-play">
        <div class="slide-track">
          <span class="slide-text">Slide to Play</span>
          <div class="slide-thumb" id="slideThumb">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="#FFD700" xmlns="http://www.w3.org/2000/svg">
              <polygon points="6,4 20,12 6,20"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal">
    <div class="modalContent">
      <h2 id="modalTitle"></h2>
      <div id="starRating" class="star-rating"></div>
      <p id="modalMsg"></p>
      <button class="retryBtn" onclick="resetLevel()">
        <svg width="1.3em" height="1.3em" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:6px;" fill="#1E90FF" xmlns="http://www.w3.org/2000/svg">
          <path d="M14.9547098,7.98576084 L15.0711,7.99552 C15.6179,8.07328 15.9981,8.57957 15.9204,9.12636 C15.6826,10.7983 14.9218,12.3522 13.747,13.5654 C12.5721,14.7785 11.0435,15.5888 9.37999,15.8801 C7.7165,16.1714 6.00349,15.9288 4.48631,15.187 C3.77335,14.8385 3.12082,14.3881 2.5472,13.8537 L1.70711,14.6938 C1.07714,15.3238 3.55271368e-15,14.8776 3.55271368e-15,13.9867 L3.55271368e-15,9.99998 L3.98673,9.99998 C4.87763,9.99998 5.3238,11.0771 4.69383,11.7071 L3.9626,12.4383 C4.38006,12.8181 4.85153,13.1394 5.36475,13.3903 C6.50264,13.9466 7.78739,14.1285 9.03501,13.9101 C10.2826,13.6916 11.4291,13.0839 12.3102,12.174 C13.1914,11.2641 13.762,10.0988 13.9403,8.84476 C14.0181,8.29798 14.5244,7.91776 15.0711,7.99552 L14.9547098,7.98576084 Z M11.5137,0.812976 C12.2279,1.16215 12.8814,1.61349 13.4558,2.14905 L14.2929,1.31193 C14.9229,0.681961 16,1.12813 16,2.01904 L16,6.00001 L12.019,6.00001 C11.1281,6.00001 10.6819,4.92287 11.3119,4.29291 L12.0404,3.56441 C11.6222,3.18346 11.1497,2.86125 10.6353,2.60973 C9.49736,2.05342 8.21261,1.87146 6.96499,2.08994 C5.71737,2.30841 4.57089,2.91611 3.68976,3.82599 C2.80862,4.73586 2.23802,5.90125 2.05969,7.15524 C1.98193,7.70202 1.47564,8.08224 0.928858,8.00448 C0.382075,7.92672 0.00185585,7.42043 0.0796146,6.87364 C0.31739,5.20166 1.07818,3.64782 2.25303,2.43465 C3.42788,1.22148 4.95652,0.411217 6.62001,0.119916 C8.2835,-0.171384 9.99651,0.0712178 11.5137,0.812976 Z"/>
        </svg>
        Retry
      </button>
      <button class="nextBtn" onclick="nextLevel()">
        <svg width="22" height="22" viewBox="0 0 22 22" style="vertical-align:middle;margin-right:6px;" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="10" stroke="#32CD32" stroke-width="2" fill="none"/>
          <path d="M9 7l4 4-4 4" stroke="#32CD32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Next
      </button>
    </div>
  </div>

  <div id="settingsModal">
    <div class="modalContent">
      <h2>⚙️ Settings</h2>
      <button onclick="toggleSound()">
        <i class="fa-solid fa-volume-up" style="margin-right:8px;color:#1E90FF;"></i>
        Sound: <span id="soundStatus">On</span>
      </button>
      <button onclick="resetHighScore()">
        <i class="fa-solid fa-rotate-left" style="margin-right:8px;color:#FFD700;"></i>
        Reset High Score
      </button>
      <button onclick="closeSettings()">
        <i class="fa-solid fa-circle-xmark" style="margin-right:8px;color:#DC143C;"></i>
        Close
      </button>
    </div>
  </div>

  <div id="startSettingsBtn" onclick="openSettings()" title="Settings">⚙️</div>
  <div id="homeBtn" title="Home" style="display:none;">
    <svg width="2.2em" height="2.2em" viewBox="0 0 24 24" fill="#888" style="vertical-align:middle;">
      <path d="M3 12L12 4l9 8" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="7" y="13" width="10" height="7" rx="2" fill="#fff9d1" stroke="#888" stroke-width="2"/>
    </svg>
  </div>

  <audio id="fireSound" src="shoot.mp3" preload="auto"></audio>
  <audio id="hitSound" src="pop.mp3" preload="auto"></audio>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let bubbles = [], arrows = [], sortedNumbers = [], currentTargetNumber = null;
    let score = 0, highScore = localStorage.getItem('highScore') || 0;
    let timeLeft = 10, timerInterval, difficulty = 'easy', soundOn = true;
    const shootBuffer = document.getElementById('fireSound');
    const popBuffer = document.getElementById('hitSound');
    const homeBtn = document.getElementById('homeBtn');

    const scoreDisplay = document.getElementById('score');
    const highScoreDisplay = document.getElementById('highScore');
    const progress = document.getElementById('progress');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const startModal = document.getElementById('startModal');
    const settingsModal = document.getElementById('settingsModal');
    const soundStatus = document.getElementById('soundStatus');
    const startHighScore = document.getElementById('startHighScore');

    const bubbleColors = ['#FFD700', '#1E90FF', '#DC143C', '#32CD32'];
    const arrowSpeed = 8;

    highScoreDisplay.textContent = highScore;
    startHighScore.textContent = highScore;
    startModal.style.display = 'flex';
    homeBtn.style.display = 'block'; // Ensure home button is visible on start

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function randomNumbers() {
      let min = 1, max = 20;
      if (difficulty === 'moderate') { min = 20; max = 50; }
      if (difficulty === 'hard') { min = 50; max = 100; }
      const nums = [];
      while (nums.length < 4) {
        let n = Math.floor(Math.random() * (max - min + 1)) + min;
        if (!nums.includes(n)) nums.push(n);
      }
      return nums;
    }

    function initBubbles(nums) {
      bubbles = [];
      let spacing = canvas.height / 5;
      for (let i = 0; i < 4; i++) {
        bubbles.push({
          x: canvas.width * 0.2,
          y: spacing * (i + 1),
          r: canvas.width * 0.07,
          number: nums[i],
          color: bubbleColors[i],
          hitColor: '#999',
          popped: false,
          bounce: 0
        });
      }
    }

    function initArrows() {
      arrows = [];
      let spacing = canvas.height / 5;
      for (let i = 0; i < 4; i++) {
        arrows.push({ id: 'arrow' + i, top: spacing * (i + 1) - 10, left: canvas.width * 0.85, moving: false });
        // Set arrow gradient to match bubble color
        const arrowEl = document.getElementById('arrow' + i);
        if (arrowEl) {
          // Get the gradient element
          const grad = arrowEl.querySelector(`#arrowGrad${i}`);
          if (grad) {
            // Set both stops to the bubble color, or use a lighter/darker shade for gradient
            grad.querySelector('stop[offset="0%"]').setAttribute('stop-color', bubbles[i]?.color || '#fff');
            grad.querySelector('stop[offset="100%"]').setAttribute('stop-color', shadeColor(bubbles[i]?.color || '#fff', -20));
          }
          // Reset arrow polygon fill to use the gradient
          const poly = arrowEl.querySelector('polygon');
          if (poly) poly.setAttribute('fill', `url(#arrowGrad${i})`);
        }
      }
    }

    // Helper to darken a hex color by percent
    function shadeColor(color, percent) {
      // color: "#RRGGBB", percent: -20 for 20% darker
      let f = parseInt(color.slice(1),16), t = percent<0?0:255, p = percent<0?percent*-1:percent;
      let R = f>>16, G = f>>8&0x00FF, B = f&0x0000FF;
      return "#" + (0x1000000 + (Math.round((t-R)*p/100)+R)*0x10000 + (Math.round((t-G)*p/100)+G)*0x100 + (Math.round((t-B)*p/100)+B)).toString(16).slice(1);
    }

    function drawBubbles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      bubbles.forEach(b => {
        // Flat pastel fill
        ctx.save();
        ctx.beginPath();
        ctx.arc(b.x, b.y - b.bounce, b.r, 0, Math.PI * 2);
        ctx.fillStyle = b.color; // Use the pastel color
        ctx.globalAlpha = b.popped ? 0.5 : 1;
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.restore();

        // Thin, slightly darker border
        ctx.save();
        ctx.beginPath();
        ctx.arc(b.x, b.y - b.bounce, b.r, 0, Math.PI * 2);
        ctx.lineWidth = 3;
        // Slightly darken the border color
        ctx.strokeStyle = shadeColor(b.color, -20);
        ctx.stroke();
        ctx.restore();

        // Bubble number
        ctx.save();
        ctx.fillStyle = '#222';
        ctx.font = `bold ${canvas.width * 0.055}px Comic Sans MS, Arial, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${b.number}`, b.x, b.y - b.bounce + 3);
        ctx.restore();
      });
    }

    function updateArrows() {
      arrows.forEach((a, i) => {
        if (a.moving) {
          if (a.left > bubbles[i].x + bubbles[i].r) {
            a.left -= arrowSpeed;
          } else {
            a.moving = false;
            bubbles[i].color = bubbles[i].hitColor;
            bubbles[i].popped = true;
            bubbles[i].bounce = 10;
            const arrowEl = document.getElementById(a.id);
            arrowEl.querySelector('polygon').setAttribute('fill', '#999');
            if (soundOn) popBuffer.cloneNode().play();
            checkLevelStatus();
          }
        }
        const el = document.getElementById(a.id);
        el.style.left = `${a.left}px`; el.style.top = `${a.top}px`;
      });
    }

    function animate() {
      bubbles.forEach(b => { if (b.bounce > 0) b.bounce -= 0.5; });
      drawBubbles();
      updateArrows();
      requestAnimationFrame(animate);
    }

    canvas.addEventListener('touchstart', e => {
      const rect = canvas.getBoundingClientRect();
      const mx = e.touches[0].clientX - rect.left, my = e.touches[0].clientY - rect.top;
      bubbles.forEach((b, i) => {
        if (!b.popped && !arrows[i].moving) {
          const dx = mx - b.x, dy = my - b.y;
          if (Math.sqrt(dx * dx + dy * dy) < b.r) {
            if (b.number === currentTargetNumber) {
              arrows[i].moving = true;
              if (soundOn) shootBuffer.cloneNode().play();
              let idx = sortedNumbers.indexOf(currentTargetNumber);
              currentTargetNumber = sortedNumbers[idx + 1];
            } else {
              failLevel(`Oops! Expected ${currentTargetNumber}.`);
            }
          }
        }
      });
    });

    function checkLevelStatus() {
      if (bubbles.every(b => b.popped)) {
        clearInterval(timerInterval);
        let bonus = timeLeft * 10, base = 100;
        score += base + bonus;
        scoreDisplay.textContent = score;
        if (score > highScore) {
          highScore = score;
          localStorage.setItem('highScore', highScore);
        }
        highScoreDisplay.textContent = highScore;
        // Star logic: 3 stars if timeLeft >= 7, 2 stars if >= 4, else 1 star
        let stars = timeLeft >= 7 ? 3 : (timeLeft >= 4 ? 2 : 1);
        showModal('🎉 Level Cleared!', `+${base} base + ${bonus} time bonus`, true, stars);
      }
    }

    function showModal(title, msg, isSuccess = false, stars = 0) {
      modalTitle.textContent = title;
      modalMsg.textContent = msg;
      const starRating = document.getElementById('starRating');
      if (isSuccess && stars > 0) {
        let starSVG = (filled, i) => `<svg class='star star-animate' style='animation-delay:${(i-1)*0.2}s' viewBox='0 0 24 24' fill='${filled ? '#FFD700' : 'none'}' stroke='#FFD700' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polygon points='12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2'/></svg>`;
        starRating.innerHTML = '';
        for (let i = 1; i <= 3; i++) starRating.innerHTML += starSVG(i <= stars, i);
        starRating.style.display = 'flex';
      } else {
        starRating.innerHTML = '';
        starRating.style.display = 'none';
      }
      modal.style.display = 'flex';
      document.querySelector('.nextBtn').style.display = isSuccess ? 'inline-block' : 'none';

      // Animate the X if failed
      if (!isSuccess && title.includes('❌')) {
        modalTitle.classList.remove('x-animate'); // reset if needed
        void modalTitle.offsetWidth; // force reflow
        modalTitle.classList.add('x-animate');
        modalTitle.addEventListener('animationend', function handler() {
          modalTitle.classList.remove('x-animate');
          modalTitle.removeEventListener('animationend', handler);
        });
      }
    }

    function updateBackgroundForDifficulty(diff) {
      let bg;
      switch (diff) {
        case 'easy':
          bg = 'linear-gradient(135deg, #fff9d1 0%, #e0f3ff 100%)';
          break;
        case 'moderate':
          bg = 'linear-gradient(135deg, #e0f3ff 0%, #ffd6de 100%)';
          break;
        case 'hard':
          bg = 'linear-gradient(135deg, #ffd6de 0%, #d9ffd6 100%)';
          break;
        default:
          bg = 'linear-gradient(135deg, #fff9d1 0%, #e0f3ff 40%, #ffd6de 80%, #d9ffd6 100%)';
      }
      document.body.style.background = bg;
    }

    function startGame(diff) {
      difficulty = diff; score = 0; scoreDisplay.textContent = score;
      startModal.style.display = 'none';
      homeBtn.style.display = 'block'; // Show home button
      updateBackgroundForDifficulty(difficulty); // Update background
      setupLevel();
    }

    function setupLevel() {
      updateBackgroundForDifficulty(difficulty); // Update background
      const nums = randomNumbers();
      sortedNumbers = [...nums].sort((a, b) => a - b);
      currentTargetNumber = sortedNumbers[0];
      initBubbles(nums); initArrows();
      progress.style.width = '100%'; modal.style.display = 'none';
      timeLeft = 10;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--; progress.style.width = (timeLeft / 10 * 100) + '%';
        if (timeLeft <= 0) { clearInterval(timerInterval); failLevel('Time up!'); }
      }, 1000);
      homeBtn.style.display = 'block'; // Ensure home button is visible on level start
    }

    function resetLevel() { modal.style.display = 'none'; setupLevel(); }
    function nextLevel() { modal.style.display = 'none'; setupLevel(); }
    function failLevel(msg) { clearInterval(timerInterval); score = 0; scoreDisplay.textContent = score; showModal('❌ Failed!', msg, false); }

    function openSettings() { settingsModal.style.display = 'flex'; soundStatus.textContent = soundOn ? 'On' : 'Off'; }
    function closeSettings() { settingsModal.style.display = 'none'; }
    function toggleSound() { soundOn = !soundOn; soundStatus.textContent = soundOn ? 'On' : 'Off'; }
    function resetHighScore() { highScore = 0; localStorage.removeItem('highScore'); highScoreDisplay.textContent = 0; }

    animate();

    let selectedDifficulty = 'easy';
    function selectDifficulty(btn, diff) {
      selectedDifficulty = diff;
      // Highlight selected button
      document.querySelectorAll('.modalContent .difficulty button').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }
    // Set default highlight
    selectDifficulty(document.querySelector('.modalContent .difficulty button'), 'easy');
    function startGame() {
      difficulty = selectedDifficulty;
      score = 0;
      scoreDisplay.textContent = score;
      startModal.style.display = 'none';
      homeBtn.style.display = 'block'; // Show home button
      updateBackgroundForDifficulty(difficulty); // Update background
      setupLevel();
    }

    homeBtn.onclick = function() {
      startModal.style.display = 'flex';
      homeBtn.style.display = 'none';
    };
  </script>

  <script>
    // Slide to Play Logic (runs immediately at end of body)
    const thumb = document.getElementById('slideThumb');
    const slideText = document.querySelector('.slide-to-play .slide-text');
    const slideTrack = thumb.parentElement;

    if (thumb) {
      thumb.style.left = '0px'; // Ensure thumb starts at left edge
      let dragging = false, startX = 0, thumbX = 0, maxX = 0;

      function setThumb(x) {
        thumb.style.left = x + 'px';
        // Blur increases as thumb moves right (max 6px)
        const percent = Math.max(0, Math.min(1, x / (slideTrack.offsetWidth - thumb.offsetWidth)));
        slideText.style.setProperty('--slide-blur', dragging ? (percent * 6) + 'px' : '0px');
        // Glow effect: increase box-shadow intensity as thumb moves right
        const glowStrength = 8 + percent * 32; // from 8px to 40px
        thumb.style.boxShadow = `0 2px ${glowStrength}px ${glowStrength/2}px #ffffffcc, 0 2px 8px #ffffff88`;
      }

      function onStart(e) {
        dragging = true;
        thumb.classList.add('active');
        startX = (e.touches ? e.touches[0].clientX : e.clientX) - thumb.offsetLeft;
        maxX = slideTrack.offsetWidth - thumb.offsetWidth;
        document.addEventListener(e.touches ? 'touchmove' : 'mousemove', onMove);
        document.addEventListener(e.touches ? 'touchend' : 'mouseup', onEnd);
        slideText.style.setProperty('--slide-blur', '0px');
      }
      function onMove(e) {
        if (!dragging) return;
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let x = clientX - startX;
        x = Math.max(0, Math.min(x, maxX));
        setThumb(x);
        thumbX = x;
      }
      function onEnd(e) {
        dragging = false;
        thumb.classList.remove('active');
        maxX = slideTrack.offsetWidth - thumb.offsetWidth;
        if (thumbX > maxX - 10) {
          // Success!
          // Haptic feedback (vibration) on success
          if (window.navigator && navigator.vibrate) {
            navigator.vibrate(30);
          }
          thumb.classList.add('success');
          slideText.style.setProperty('--slide-blur', '0px');
          setTimeout(() => {
            thumb.classList.remove('success');
            setThumb(0);
            thumbX = 0;
            startGame();
          }, 400);
        } else {
          // Animate back
          thumb.style.transition = 'left 0.3s cubic-bezier(.4,0,.2,1)';
          setThumb(0);
          // Remove glow when sliding back
          thumb.style.boxShadow = '';
          setTimeout(() => {
            thumb.style.transition = '';
            thumbX = 0;
            slideText.style.setProperty('--slide-blur', '0px');
          }, 300);
        }
        document.removeEventListener(e.type === 'touchend' ? 'touchmove' : 'mousemove', onMove);
        document.removeEventListener(e.type === 'touchend' ? 'touchend' : 'mouseup', onEnd);
      }
      thumb.addEventListener('mousedown', onStart);
      thumb.addEventListener('touchstart', onStart);
    }

    // When start modal is shown, trigger the shimmer animation (no JS needed, always animates)
    function showStartModal() {
      document.getElementById('startModal').style.display = 'flex';
    }
    function hideStartModal() {
      document.getElementById('startModal').style.display = 'none';
    }

    // On page load, shimmer animates automatically
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>

  <script>
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); // Stop auto prompt
      deferredPrompt = e;
      installBtn.style.display = 'block'; // Show button
    });

    installBtn.addEventListener('click', () => {
      installBtn.style.display = 'none';
      if (deferredPrompt) {
        deferredPrompt.prompt(); // Show install prompt
        deferredPrompt.userChoice.then(choiceResult => {
          if (choiceResult.outcome === 'accepted') {
            console.log('✅ User installed the app');
          } else {
            console.log('❌ User dismissed install');
          }
          deferredPrompt = null;
        });
      }
    });
  </script>

</body>

</html>